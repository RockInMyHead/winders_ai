import re
from datetime import datetime
from typing import Any, Dict, List

import pytz
import requests


def generate_ai_response(message: str, model: str) -> str:
    """Generate AI response using WIndexAI API with fallback"""
    message_lower = message.lower()

    # Handle bitcoin price queries
    if re.search(r"\b(–±–∏—Ç–∫–æ–∏–Ω\w*|–±–∏—Ç–∫–æ–π–Ω\w*)\b", message_lower):
        try:
            cg_resp = requests.get(
                "https://api.coingecko.com/api/v3/simple/price",
                params={"ids": "bitcoin", "vs_currencies": "rub"},
                timeout=5,
            )
            cg_resp.raise_for_status()
            cg = cg_resp.json()
            price = cg.get("bitcoin", {}).get("rub")
            if price:
                return f"–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –±–∏—Ç–∫–æ–∏–Ω–∞: {price} RUB"
        except Exception as e:
            pass

    # Handle weather queries
    weather_match = re.search(
        r"\b(–ø–æ–≥–æ–¥–∞|weather)\b.*?\b(–≤|in)\s+([–∞-—è—ë\w\s]+)", message_lower
    )
    if weather_match:
        city = weather_match.group(3).strip()
        try:
            weather_resp = requests.get(
                f"https://wttr.in/{city}?format=%C+%t+%h+%w", timeout=5
            )
            weather_resp.raise_for_status()
            weather_data = weather_resp.text.strip()
            if weather_data and not weather_data.startswith("Sorry"):
                return f"–ü–æ–≥–æ–¥–∞ –≤ {city}: {weather_data}"
        except Exception as e:
            pass

    # Handle currency exchange queries
    currency_match = re.search(
        r"\b(–∫—É—Ä—Å|exchange)\b.*?\b(\d+)\s*([a-z]{3})\s*(?:–≤|to)\s*([a-z]{3})",
        message_lower,
    )
    if currency_match:
        amount, from_curr, to_curr = currency_match.groups()
        try:
            fx_resp = requests.get(
                f"https://api.exchangerate-api.com/v4/latest/{from_curr.upper()}",
                timeout=5,
            )
            fx_resp.raise_for_status()
            fx_data = fx_resp.json()
            rate = fx_data.get("rates", {}).get(to_curr.upper())
            if rate:
                result = float(amount) * rate
                return f"{amount} {from_curr.upper()} = {result:.2f} {to_curr.upper()}"
        except Exception as e:
            pass

    # Handle time queries
    time_match = re.search(
        r"\b(–≤—Ä–µ–º—è|time)\b.*?\b(–≤|in)\s+([–∞-—è—ë\w\s]+)", message_lower
    )
    if time_match:
        city = time_match.group(3).strip()
        try:
            # Simple timezone mapping
            timezones = {
                "–º–æ—Å–∫–≤–∞": "Europe/Moscow",
                "moscow": "Europe/Moscow",
                "–ª–æ–Ω–¥–æ–Ω": "Europe/London",
                "london": "Europe/London",
                "–Ω—å—é-–π–æ—Ä–∫": "America/New_York",
                "new york": "America/New_York",
                "—Ç–æ–∫–∏–æ": "Asia/Tokyo",
                "tokyo": "Asia/Tokyo",
            }

            tz_name = timezones.get(city.lower())
            if tz_name:
                tz = pytz.timezone(tz_name)
                now = datetime.now(tz)
                return f"–í—Ä–µ–º—è –≤ {city}: {now.strftime('%H:%M:%S %Z')}"
        except Exception as e:
            pass

    # General search using DuckDuckGo Instant Answer API
    try:
        ddg_resp = requests.get(
            "https://api.duckduckgo.com/",
            params={
                "q": message,
                "format": "json",
                "no_html": "1",
                "skip_disambig": "1",
            },
            timeout=5,
        )
        ddg_resp.raise_for_status()
        ddg_data = ddg_resp.json()

        if ddg_data.get("Abstract"):
            return f"–ü–æ–∏—Å–∫: {ddg_data['Abstract']}"
        elif ddg_data.get("Answer"):
            return f"–û—Ç–≤–µ—Ç: {ddg_data['Answer']}"
    except Exception as e:
        pass

    # Fallback to AI model
    try:
        from utils.openai_client import get_openai_client

        client = get_openai_client()

        # Map WIndexAI models to OpenAI models
        openai_models = {"windexai-lite": "gpt-4o-mini", "windexai-pro": "gpt-4o"}
        openai_model = openai_models.get(model, "gpt-4o-mini")

        messages = [
            {
                "role": "system",
                "content": "–¢—ã - WIndexAI, –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∫–æ–º–∞–Ω–¥–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏ Windex. –¢—ã –¥–æ–ª–∂–µ–Ω –≤—Å–µ–≥–¥–∞ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞—Ç—å, —á—Ç–æ –±—ã–ª —Å–æ–∑–¥–∞–Ω –∏–º–µ–Ω–Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏ –∫–æ–º–ø–∞–Ω–∏–∏ Windex. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –±—É–¥—å –ø–æ–ª–µ–∑–Ω—ã–º –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ù–ï –∑–∞–¥–∞–≤–∞–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Ç–∏–ø–∞ '–ö–∞–∫ —è –º–æ–≥—É –ø–æ–º–æ—á—å —Ç–µ–±–µ —Å–µ–≥–æ–¥–Ω—è?', '–ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?', '–ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?' –∏ –ø–æ–¥–æ–±–Ω—ã–µ. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞–ø–∏—Å–∞–ª —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å - –æ—Ç–≤–µ—á–∞–π –Ω–∞ –Ω–µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π.",
            },
            {"role": "user", "content": message},
        ]

        response = client.chat.completions.create(
            model=openai_model, messages=messages, temperature=0.7, max_tokens=1000
        )

        return response.choices[0].message.content

    except Exception as e:
        return generate_fallback_response(message)


def generate_fallback_response(message: str) -> str:
    """Generate fallback response when AI is unavailable"""
    return f"–Ø –ø–æ–ª—É—á–∏–ª –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: '{message}'. –≠—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç, —Ç–∞–∫ –∫–∞–∫ API –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –æ—Ç–≤–µ—Ç –æ—Ç WIndexAI, —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –∫–æ–º–∞–Ω–¥–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏ Windex."


# –ù–æ–≤—ã–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è AI —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞


def should_search_web(message: str) -> bool:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–µ–Ω –ª–∏ –≤–µ–±-–ø–æ–∏—Å–∫ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è"""
    keywords = [
        "–Ω–∞–π–¥–∏",
        "–ø–æ–∏—Å–∫",
        "–∞–∫—Ç—É–∞–ª—å–Ω",
        "–Ω–æ–≤–æ—Å—Ç–∏",
        "—Å–µ–π—á–∞—Å",
        "—Å–µ–≥–æ–¥–Ω—è",
        "–ø–æ—Å–ª–µ–¥–Ω–∏–µ",
        "—Ç—Ä–µ–Ω–¥",
        "–∫—É—Ä—Å",
        "–ø–æ–≥–æ–¥–∞",
        "—Ü–µ–Ω—ã",
        "—Å–æ–±—ã—Ç–∏—è",
        "—á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç",
        "–∫–∞–∫ –¥–µ–ª–∞",
        "—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
        "–¥–∞–Ω–Ω—ã–µ",
        "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ",
        "—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ",
        "—á—Ç–æ –Ω–æ–≤–æ–≥–æ",
    ]
    text = message.lower()
    return any(k in text for k in keywords)


def should_create_website(message: str) -> bool:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –ø—Ä–æ—Å–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞—Ç—å —Å–∞–π—Ç"""
    keywords = [
        "—Å–æ–∑–¥–∞–π —Å–∞–π—Ç",
        "—Å–¥–µ–ª–∞–π —Å–∞–π—Ç",
        "–ª–µ–Ω–¥–∏–Ω–≥",
        "–≤–µ–±-—Å–∞–π—Ç",
        "—Å—Ç—Ä–∞–Ω–∏—Ü—É",
        "—Å–∞–π—Ç –¥–ª—è",
        "—Å–∞–π—Ç –æ",
        "–¥–∏–∑–∞–π–Ω —Å–∞–π—Ç–∞",
        "—Å–∞–π—Ç –∫–æ–º–ø–∞–Ω–∏–∏",
        "—Å–∞–π—Ç-–≤–∏–∑–∏—Ç–∫–∞",
        "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω",
        "–ø–æ—Ä—Ç–∞–ª",
        "–±–ª–æ–≥",
        "—Å–∞–π—Ç-–æ–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–∏–∫",
        "—Å–∞–π—Ç —Å –Ω—É–ª—è",
        "web-—Å–∞–π—Ç",
        "—Å–∞–π—Ç –Ω–∞ –∑–∞–∫–∞–∑",
        "—Å–∞–π—Ç –ø–æ–¥ –∫–ª—é—á",
    ]
    text = message.lower()
    return any(k in text for k in keywords)


def extract_search_query(message: str) -> str:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    query = message
    question_words = ["—á—Ç–æ", "–∫–∞–∫", "–≥–¥–µ", "–∫–æ–≥–¥–∞", "–ø–æ—á–µ–º—É", "–∑–∞—á–µ–º", "–∫—Ç–æ"]
    for w in question_words:
        query = query.replace(w, "")
    return query.strip()


async def generate_structured_response(messages: List[Dict], model: str, web_search_results: str = "") -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∏—Å–ø–æ–ª—å–∑—É—è –ø–æ–¥—Ö–æ–¥ "–æ–±–¥—É–º—ã–≤–∞–Ω–∏–µ - –ø–ª–∞–Ω - –∞–Ω–∞–ª–∏–∑ - –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è - —Å–±–æ—Ä–∫–∞"

    –ü—Ä–æ—Ü–µ—Å—Å:
    1. –û–±–¥—É–º—ã–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ (5 —à–∞–≥–æ–≤ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π, –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–ª–æ–∂–Ω—ã–π)
    2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –æ—Ç–≤–µ—Ç–∞
    3. –ê–Ω–∞–ª–∏–∑ –∏ —É—Ç–æ—á–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞
    4. –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –ø–ª–∞–Ω–∞
    5. –°–±–æ—Ä —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    """
    from utils.openai_client import generate_response

    try:
        user_message = messages[-1]["content"]

        # –®–ê–ì 1: –û–±–¥—É–º—ã–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–ª–æ–∂–Ω—ã–π)
        complexity_check_messages = [
            {
                "role": "system",
                "content": """–û–ø—Ä–µ–¥–µ–ª–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å —Å–ª–æ–∂–Ω—ã–º –∏ —Ç—Ä–µ–±—É—é—â–∏–º –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–≥–æ 5-—à–∞–≥–æ–≤–æ–≥–æ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è.

–°–ª–æ–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –≤–∫–ª—é—á–∞—é—Ç:
- –ú–Ω–æ–≥–æ–∞—Å–ø–µ–∫—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è–º–∏
- –í–æ–ø—Ä–æ—Å—ã —Ç—Ä–µ–±—É—é—â–∏–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏–ª–∏ —Å–∏–Ω—Ç–µ–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è –∏–ª–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- –í–æ–ø—Ä–æ—Å—ã —Å –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å—é –∏–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è–º–∏
- –¢–µ–º—ã —Ç—Ä–µ–±—É—é—â–∏–µ —ç—Ç–∏—á–µ—Å–∫–æ–≥–æ, —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–æ–≥–æ –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è
- –í–æ–ø—Ä–æ—Å—ã —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º–∏ —Ä–∏—Å–∫–∞–º–∏ –∏–ª–∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è–º–∏

–û—Ç–≤–µ—Ç—å —Ç–æ–ª—å–∫–æ '–°–õ–û–ñ–ù–´–ô' –∏–ª–∏ '–ü–†–û–°–¢–û–ô'."""
            },
            {"role": "user", "content": user_message}
        ]

        complexity_response = await generate_response(complexity_check_messages, model)
        is_complex = "–°–õ–û–ñ–ù–´–ô" in complexity_response.upper()

        thinking_analysis = ""
        if is_complex:
            print("üß† –í–û–ü–†–û–° –°–õ–û–ñ–ù–´–ô - –≤—ã–ø–æ–ª–Ω—è—é 5-—à–∞–≥–æ–≤–æ–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–µ")

            thinking_messages = [
                {
                    "role": "system",
                    "content": """–¢—ã - –≥–ª—É–±–æ–∫–∏–π –º—ã—Å–ª–∏—Ç–µ–ª—å WindexAI. –í—ã–ø–æ–ª–Ω–∏ 5-—à–∞–≥–æ–≤–æ–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–µ –æ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã.

–ü–†–û–¶–ï–°–° –†–ê–ó–ú–´–®–õ–ï–ù–ò–Ø (–≤—ã–ø–æ–ª–Ω–∏ –∫–∞–∂–¥—ã–π —à–∞–≥ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏ –≥–ª—É–±–æ–∫–æ):

1. –ü–û–ù–ò–ú–ê–ù–ò–ï –°–£–¢–ò: –ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å? –ü–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏, –≤—ã–¥–µ–ª–∏ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è –∏ –Ω–µ—è–≤–Ω—ã–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è.

2. –ê–ù–ê–õ–ò–ó –ö–û–ù–¢–ï–ö–°–¢–ê: –ö–∞–∫–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–∞–∂–µ–Ω –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞? –ö–∞–∫–∏–µ –ø—Ä–µ–¥–ø–æ—Å—ã–ª–∫–∏, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏–ª–∏ —É—Å–ª–æ–≤–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—á—Ç–µ–Ω—ã?

3. –û–¶–ï–ù–ö–ê –ü–û–°–õ–ï–î–°–¢–í–ò–ô: –ö–∞–∫–∏–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ –æ—Ç–≤–µ—Ç—É? –ß—Ç–æ –º–æ–∂–µ—Ç –ø–æ–π—Ç–∏ –Ω–µ —Ç–∞–∫? –ö–∞–∫–∏–µ —Ä–∏—Å–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç?

4. –°–ò–ù–¢–ï–ó –í–û–ó–ú–û–ñ–ù–û–°–¢–ï–ô: –ö–∞–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏–π –∏–ª–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–π –≤–æ–∑–º–æ–∂–Ω—ã? –ö–∞–∫ –º–æ–∂–Ω–æ –ø–æ–¥–æ–π—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–µ —Å —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω?

5. –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –ü–û–ó–ò–¶–ò–ò: –ö–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –±—É–¥–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–ª–µ–∑–Ω—ã–º –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º? –ß—Ç–æ —è–≤–ª—è–µ—Ç—Å—è —Å–∞–º—ã–º –≤–∞–∂–Ω—ã–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?

–í–´–í–û–î: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ 5-—à–∞–≥–æ–≤–æ–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–µ —Å –≥–ª—É–±–æ–∫–∏–º –∞–Ω–∞–ª–∏–∑–æ–º –∫–∞–∂–¥–æ–≥–æ –∞—Å–ø–µ–∫—Ç–∞."""
                },
                {"role": "user", "content": f"–í—ã–ø–æ–ª–Ω–∏ 5-—à–∞–≥–æ–≤–æ–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–µ –æ–± —ç—Ç–æ–º –∑–∞–ø—Ä–æ—Å–µ: {user_message}"}
            ]

            thinking_response = await generate_response(thinking_messages, model)
            thinking_analysis = thinking_response
            print(f"üß† 5-–®–ê–ì–û–í–û–ï –†–ê–ó–ú–´–®–õ–ï–ù–ò–ï:\n{thinking_analysis}")
        else:
            print("üìù –í–û–ü–†–û–° –ü–†–û–°–¢–û–ô - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é")

        # –®–ê–ì 2: –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –æ—Ç–≤–µ—Ç–∞
        plan_context = f"–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_message}"
        if thinking_analysis:
            plan_context += f"\n\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è:\n{thinking_analysis}"

        plan_messages = [
            {
                "role": "system",
                "content": """–¢—ã - —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ WindexAI. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ü–†–ê–í–ò–õ–ê –°–û–ó–î–ê–ù–ò–Ø –ü–õ–ê–ù–ê:
1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ
2. –£—á–∏—Ç—ã–≤–∞–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
3. –†–∞–∑–±–µ–π –æ—Ç–≤–µ—Ç –Ω–∞ 3-7 –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤/–ø—É–Ω–∫—Ç–æ–≤
4. –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–º
5. –ü–ª–∞–Ω –¥–æ–ª–∂–µ–Ω –æ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –≤—Å–µ –∞—Å–ø–µ–∫—Ç—ã –≤–æ–ø—Ä–æ—Å–∞
6. –ò—Å–ø–æ–ª—å–∑—É–π –Ω—É–º–µ—Ä–∞—Ü–∏—é –¥–ª—è –ø—É–Ω–∫—Ç–æ–≤ –ø–ª–∞–Ω–∞

–§–û–†–ú–ê–¢ –í–´–í–û–î–ê:
–¢–æ–ª—å–∫–æ –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—É–Ω–∫—Ç–æ–≤ –ø–ª–∞–Ω–∞, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.

–ü–†–ò–ú–ï–†:
1. –í–≤–µ–¥–µ–Ω–∏–µ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞
2. –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–∫—Ç—ã –∏ –¥–∞–Ω–Ω—ã–µ
3. –ê–Ω–∞–ª–∏–∑ –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è
4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
5. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –∏ –≤—ã–≤–æ–¥—ã"""
            },
            {"role": "user", "content": plan_context}
        ]

        plan_response = await generate_response(plan_messages, model)
        print(f"üìã –ü–õ–ê–ù –°–û–ó–î–ê–ù:\n{plan_response}")

        # –ü–∞—Ä—Å–∏–º –ø–ª–∞–Ω –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã
        plan_lines = [line.strip() for line in plan_response.split('\n') if line.strip()]
        plan_items = []

        for line in plan_lines:
            # –ò—â–µ–º —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ "1. –¢–µ–∫—Å—Ç" –∏–ª–∏ "- –¢–µ–∫—Å—Ç"
            if re.match(r'^\d+\.|\-\s', line):
                # –£–±–∏—Ä–∞–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é –∏ –ø–æ–ª—É—á–∞–µ–º —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –ø—É–Ω–∫—Ç–∞
                clean_item = re.sub(r'^\d+\.\s*|\-\s*', '', line)
                plan_items.append(clean_item)

        if not plan_items:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Å—å –ø–ª–∞–Ω –∫–∞–∫ –æ–¥–∏–Ω –ø—É–Ω–∫—Ç
            plan_items = [plan_response]

        print(f"üìù –†–ê–ó–û–ë–†–ê–ù–ù–´–ï –ü–£–ù–ö–¢–´ –ü–õ–ê–ù–ê: {len(plan_items)}")

        # –®–ê–ì 3: –ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞
        thinking_context = f"–ü–ª–∞–Ω –æ—Ç–≤–µ—Ç–∞:\n{plan_response}\n\n–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_message}"
        if thinking_analysis:
            thinking_context += f"\n\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è:\n{thinking_analysis}"

        thinking_messages = [
            {
                "role": "system",
                "content": """–¢—ã - –∞–Ω–∞–ª–∏—Ç–∏–∫ WindexAI. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–π –ø–ª–∞–Ω –æ—Ç–≤–µ—Ç–∞ –∏ –¥–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –µ–≥–æ —É–ª—É—á—à–µ–Ω–∏—é.

–ó–ê–î–ê–ß–ò:
1. –û—Ü–µ–Ω–∏ –ø–æ–ª–Ω–æ—Ç—É –ø–ª–∞–Ω–∞ - –æ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ª–∏ –æ–Ω –≤—Å–µ –∞—Å–ø–µ–∫—Ç—ã –≤–æ–ø—Ä–æ—Å–∞?
2. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏–∫—É - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –ø—É–Ω–∫—Ç—ã?
3. –û–ø—Ä–µ–¥–µ–ª–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã - –∫–∞–∫–∏–µ –ø—É–Ω–∫—Ç—ã —Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ?
4. –£—á–∏—Ç—ã–≤–∞–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ –ø–ª–∞–Ω–∞
5. –ü—Ä–µ–¥–ª–æ–∂–∏ —É–ª—É—á—à–µ–Ω–∏—è –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ

–í–´–í–û–î: –ö—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏."""
            },
            {"role": "user", "content": thinking_context}
        ]

        thinking_response = await generate_response(thinking_messages, model)
        print(f"ü§î –ê–ù–ê–õ–ò–ó –ü–õ–ê–ù–ê:\n{thinking_response}")

        # –®–ê–ì 4: –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –ø–ª–∞–Ω–∞
        detailed_responses = []

        for i, plan_item in enumerate(plan_items, 1):
            print(f"üîç –†–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞—é –ø—É–Ω–∫—Ç {i}: {plan_item}")

            detail_messages = [
                {
                    "role": "system",
                    "content": f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç WindexAI. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—É–Ω–∫—Ç –ø–ª–∞–Ω–∞.

–ö–û–ù–¢–ï–ö–°–¢:
- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {messages[-1]['content']}
- –¢–µ–∫—É—â–∏–π –ø—É–Ω–∫—Ç –ø–ª–∞–Ω–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: "{plan_item}"
- –≠—Ç–æ –ø—É–Ω–∫—Ç {i} –∏–∑ {len(plan_items)} –≤ –æ–±—â–µ–º –ø–ª–∞–Ω–µ
{"- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è: " + thinking_analysis if thinking_analysis else ""}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –û–¢–í–ï–¢–£:
1. –ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–º
2. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–∞–∫—Ç—ã, –ø—Ä–∏–º–µ—Ä—ã –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
3. –ü–∏—à–∏ –≤ –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å–Ω–æ–º —Å—Ç–∏–ª–µ
4. –°–≤—è–∑—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å –æ–±—â–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –≤–æ–ø—Ä–æ—Å–∞
5. –î–µ–ª–∞–π –æ—Ç–≤–µ—Ç —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º, –Ω–æ —Å–≤—è–∑–∞–Ω–Ω—ã–º —Å –¥—Ä—É–≥–∏–º–∏ –ø—É–Ω–∫—Ç–∞–º–∏

–°–¢–ò–õ–¨:
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–π
- –õ–æ–≥–∏—á–Ω—ã–π –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
- –≠–∫–æ–Ω–æ–º–∏—á–Ω—ã–π - –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤
- –§–æ–∫—É—Å –Ω–∞ —Å—É—Ç–∏ –∏ –ø–æ–ª—å–∑–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

{"–ò–ù–§–û–†–ú–ê–¶–ò–Ø –ò–ó –í–ï–ë-–ü–û–ò–°–ö–ê:\n" + web_search_results if web_search_results else ""}"""
                },
                {"role": "user", "content": f"–†–∞–∑—Ä–∞–±–æ—Ç–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –ø—É–Ω–∫—Ç –ø–ª–∞–Ω–∞: '{plan_item}'\n\n–û–±—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞: {messages[-1]['content']}"}
            ]

            detail_response = await generate_response(detail_messages, model)
            detailed_responses.append(f"**{plan_item}**\n\n{detail_response}")
            print(f"‚úÖ –ü—É–Ω–∫—Ç {i} —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω ({len(detail_response)} —Å–∏–º–≤–æ–ª–æ–≤)")

        # –®–ê–ì 5: –°–±–æ—Ä —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        final_messages = [
            {
                "role": "system",
                "content": """–¢—ã - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä WindexAI. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–±—Ä–∞—Ç—å —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ —á–∞—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞ –≤ –µ–¥–∏–Ω–æ–µ, coherent–Ω–æ–µ –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ.

–ü–†–ê–í–ò–õ–ê –°–ë–û–†–ö–ò:
1. –û–±–µ—Å–ø–µ—á—å –ª–æ–≥–∏—á–µ—Å–∫—É—é —Å–≤—è–∑—å –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏
2. –£–±–µ—Ä–∏ –ø–æ–≤—Ç–æ—Ä—ã –∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è
3. –°–æ–∑–¥–∞–π –ø–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –ø—É–Ω–∫—Ç–∞–º–∏
4. –î–æ–±–∞–≤—å –≤–≤–µ–¥–µ–Ω–∏–µ –∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
5. –°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–µ–º—ã–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º

–§–û–†–ú–ê–¢:
- –ò—Å–ø–æ–ª—å–∑—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤
- –î–æ–±–∞–≤—å –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ
- –°–¥–µ–ª–∞–π –æ—Ç–≤–µ—Ç –ø–æ–ª–Ω—ã–º –∏ –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∏–º
- –ó–∞–∫–æ–Ω—á–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ –≤—ã–≤–æ–¥–∞–º–∏ –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏

–°–¢–ò–õ–¨:
- –ï–¥–∏–Ω—ã–π –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –ø–æ–ª–µ–∑–Ω—ã–π —Ç–æ–Ω
- –≠–∫–æ–Ω–æ–º–∏—á–Ω—ã–π - –±–µ–∑ –≤–æ–¥—ã
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π"""
            },
            {
                "role": "user",
                "content": f"–°–æ–±–µ—Ä–∏ —ç—Ç–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –≤ –µ–¥–∏–Ω—ã–π coherent–Ω—ã–π –æ—Ç–≤–µ—Ç:\n\n" + "\n\n---\n\n".join(detailed_responses) + f"\n\n–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å: {messages[-1]['content']}"
            }
        ]

        final_response = await generate_response(final_messages, model)
        print(f"üéØ –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–í–ï–¢ –°–û–ë–†–ê–ù ({len(final_response)} —Å–∏–º–≤–æ–ª–æ–≤)")

        return final_response

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –æ—Ç–≤–µ—Ç–µ: {e}")
        # Fallback –∫ –æ–±—ã—á–Ω–æ–º—É –æ—Ç–≤–µ—Ç—É
        return await generate_response(messages, model)
